<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RSVP Bot - User Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>User Dashboard</h1>
      <p>Submit your event details and invitees list.</p>
    </header>
    <main>
      <div class="notice">
        After submitting your event and completing payment, wait for admin approval. Approved events trigger WhatsApp invites.
      </div>
      <div class="card">
        <h2>Create Event</h2>
        <form id="event-form">
          <div class="grid">
            <div>
              <label for="title">Event title</label>
              <input id="title" required />
            </div>
            <div>
              <label for="event-date">Event date</label>
              <input id="event-date" type="date" required />
            </div>
          </div>
          <div style="margin-top: 16px;">
            <label for="notes">Notes</label>
            <textarea id="notes" rows="3"></textarea>
          </div>
          <div style="margin-top: 16px;">
            <label for="invitees">Invitees (one per line: Name, Phone)</label>
            <textarea id="invitees" rows="6" required></textarea>
          </div>
          <button type="submit" style="margin-top: 16px;">Submit event</button>
        </form>
        <p id="event-message" class="small"></p>
      </div>

      <div class="card">
        <h2>Your Events</h2>
        <div id="events"></div>
      </div>
    </main>
    <script>
      const token = localStorage.getItem("userToken");
      const eventForm = document.getElementById("event-form");
      const eventMessage = document.getElementById("event-message");
      const eventsContainer = document.getElementById("events");

      if (!token) {
        window.location.href = "user-login.html";
      }

      const fetchEvents = async () => {
        const response = await fetch("/api/events/mine", {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!response.ok) {
          return;
        }
        const data = await response.json();
        eventsContainer.innerHTML = "";
        if (!data.events.length) {
          eventsContainer.innerHTML = "<p class='small'>No events yet.</p>";
          return;
        }
        data.events.forEach((event) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="inline" style="justify-content: space-between; align-items: center;">
              <div>
                <h3>${event.title}</h3>
                <p class="small">${event.eventDate}</p>
              </div>
              <span class="status ${event.status}">${event.status.replace('_', ' ')}</span>
            </div>
            <p>${event.notes || "No notes."}</p>
            <p class="small">Payment: ${event.paid ? "Paid" : "Pending"}</p>
          `;
          if (!event.paid) {
            const payButton = document.createElement("button");
            payButton.textContent = "Mark as paid";
            payButton.addEventListener("click", async () => {
              await fetch(`/api/events/${event.id}/pay`, {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` }
              });
              fetchEvents();
            });
            card.appendChild(payButton);
          }
          eventsContainer.appendChild(card);
        });
      };

      eventForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        eventMessage.textContent = "";
        const inviteLines = document.getElementById("invitees").value
          .split("\n")
          .map((line) => line.trim())
          .filter(Boolean);
        const invitees = inviteLines.map((line) => {
          const [name, phone] = line.split(",").map((item) => item.trim());
          return { name, phone };
        });
        const payload = {
          title: document.getElementById("title").value.trim(),
          eventDate: document.getElementById("event-date").value,
          notes: document.getElementById("notes").value.trim(),
          invitees
        };
        const response = await fetch("/api/events", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(payload)
        });
        if (response.ok) {
          eventMessage.textContent = "Event submitted for approval.";
          eventForm.reset();
          fetchEvents();
        } else {
          const data = await response.json();
          eventMessage.textContent = data.error || "Failed to submit event.";
        }
      });

      fetchEvents();
    </script>
  </body>
</html>
